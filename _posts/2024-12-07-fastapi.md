---
layout:     post
title:      "FastAPIæ–°æ‰‹æ•™ç¨‹"
subtitle:   "FastAPI tutorial"
date:       2024-12-07
author:     "Jack Ding"
header-style: text
tags:
    - IT
    - tutorial
---

å› ä¸ºæˆ‘åé¢è¦ç”¨Vue+FastAPIåšä¸€ä¸ªå‰åç«¯åˆ†ç¦»çš„ç³»ç»Ÿï¼Œä»¥å‰ä¹Ÿæ²¡æœ‰FastAPIçš„åŸºç¡€ï¼Œæ‰€ä»¥è¿™æ¬¡ä¸€è¾¹å­¦ä¹ ï¼Œä¸€è¾¹å®è·µï¼Œä¸€è¾¹æ•´ç†è¿™ä»½æ•™ç¨‹ï¼Œå¸Œæœ›èƒ½å¸®åŠ©åˆ°ä½ ã€‚

# ä»€ä¹ˆæ˜¯FastAPI

**Fastapiï¼Œä¸€ä¸ªç”¨äºæ„å»º API çš„ç°ä»£ã€å¿«é€Ÿï¼ˆé«˜æ€§èƒ½ï¼‰çš„webæ¡†æ¶ï¼Œä½¿ç”¨ Python å¹¶åŸºäºæ ‡å‡†çš„ Python ç±»å‹æç¤ºã€‚**

- FastAPIçš„ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼šStarletteï¼ŒPydanticï¼ŒStarletteè´Ÿè´£webéƒ¨åˆ†ï¼ŒPydanticè´Ÿè´£æ•°æ®éƒ¨åˆ†ã€‚
- Pydanticæ˜¯ä¸€ä¸ªåŸºäºPythonç±»å‹æç¤ºæ¥å®šä¹‰æ•°æ®éªŒè¯ã€åºåˆ—åŒ–å’Œæ–‡æ¡£çš„åº“ã€‚
- Starletteæ˜¯ä¸€ç§è½»é‡çº§çš„ASGIæ¡†æ¶/å·¥å…·åŒ…ï¼Œæ˜¯æ„å»ºé«˜æ€§èƒ½AsyncioæœåŠ¡çš„ç†æ€§é€‰æ‹©ã€‚

**FastAPIçš„å…³é”®ç‰¹æ€§ï¼š**

- å¿«é€Ÿï¼šå¯ä¸ NodeJS å’Œ Go æ¯”è‚©çš„æé«˜æ€§èƒ½ï¼ˆå½’åŠŸäº Starlette å’Œ Pydanticï¼‰ï¼Œæ˜¯æœ€å¿«çš„ Python web æ¡†æ¶ä¹‹ä¸€ã€‚
- é«˜æ•ˆç¼–ç ï¼šæé«˜åŠŸèƒ½å¼€å‘é€Ÿåº¦çº¦ 200ï¼… è‡³ 300ï¼…ã€‚
- æ›´å°‘bugï¼šå‡å°‘çº¦ 40ï¼… çš„äººä¸ºï¼ˆå¼€å‘è€…ï¼‰å¯¼è‡´é”™è¯¯ã€‚
- æ™ºèƒ½ï¼šæä½³çš„ç¼–è¾‘å™¨æ”¯æŒã€‚å¤„å¤„çš†å¯è‡ªåŠ¨è¡¥å…¨ï¼Œå‡å°‘è°ƒè¯•æ—¶é—´ã€‚
- ç®€å•ï¼šè®¾è®¡çš„æ˜“äºä½¿ç”¨å’Œå­¦ä¹ ï¼Œé˜…è¯»æ–‡æ¡£çš„æ—¶é—´æ›´çŸ­ã€‚
- ç®€çŸ­ï¼šä½¿ä»£ç é‡å¤æœ€å°åŒ–ã€‚é€šè¿‡ä¸åŒçš„å‚æ•°å£°æ˜å®ç°ä¸°å¯ŒåŠŸèƒ½ã€‚
- å¥å£®ï¼šç”Ÿäº§å¯ç”¨çº§åˆ«çš„ä»£ç ã€‚è¿˜æœ‰è‡ªåŠ¨ç”Ÿæˆçš„äº¤äº’å¼æ–‡æ¡£ã€‚
- æ ‡å‡†åŒ–ï¼šåŸºäºï¼ˆå¹¶å®Œå…¨å…¼å®¹ï¼‰APIçš„ç›¸å…³å¼€æ”¾æ ‡å‡†ï¼šOpenAPIï¼ˆä»¥å‰è¢«ç§°ä¸ºSwaggerï¼‰å’ŒJSON Schemaã€‚

> å¦‚æœä½ åœ¨å¼€å‘ä¸€ä¸ªåœ¨ç»ˆç«¯ä¸­è¿è¡Œçš„å‘½ä»¤è¡Œåº”ç”¨è€Œä¸æ˜¯web APIï¼Œä¸å¦¨è¯•ä¸‹[Typer](https://typer.tiangolo.com/)ã€‚
>
> Typeræ˜¯FastAPIçš„å°åŒèƒï¼Œå®ƒæƒ³è¦æˆä¸ºå‘½ä»¤è¡Œä¸­çš„FastAPIã€‚



# FastAPIå®‰è£…

```bash
pip install fastapi
```

ä½ è¿˜ä¼šéœ€è¦ä¸€ä¸ªASGIæœåŠ¡å™¨ï¼Œç”Ÿäº§ç¯å¢ƒå¯ä»¥ä½¿ç”¨[Uvicorn](https://www.uvicorn.org/)æˆ–è€…[Hypercorn](https://github.com/pgjones/hypercorn)ã€‚

```bash
pip install "uvicorn[standard]"
```

# ç¤ºä¾‹

Fastapiå¼€å‘webç¨‹åºæµç¨‹ï¼š
ï¼ˆ1ï¼‰å¯¼å…¥ FastAPIã€‚
ï¼ˆ2ï¼‰åˆ›å»ºä¸€ä¸ª app å®ä¾‹ã€‚
ï¼ˆ3ï¼‰ç¼–å†™ä¸€ä¸ªè·¯å¾„æ“ä½œè£…é¥°å™¨ï¼ˆå¦‚ @app.get(â€œ/â€)ï¼‰
ï¼ˆ4ï¼‰ç¼–å†™ä¸€ä¸ªè·¯å¾„æ“ä½œå‡½æ•°ï¼ˆå¦‚ä¸Šé¢çš„ def root(): â€¦ï¼‰
ï¼ˆ5ï¼‰å®šä¹‰è¿”å›å€¼
ï¼ˆ6ï¼‰è¿è¡Œå¼€å‘æœåŠ¡å™¨ï¼ˆå¦‚ uvicorn main:app --reloadï¼‰

åˆ›å»ºä¸€ä¸ª`main.py`æ–‡ä»¶å¹¶å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š

```python
from typing import Union

from fastapi import FastAPI

app = FastAPI()


@app.get("/")
def read_root():
    return {"Hello": "World"}


@app.get("/items/{item_id}")
def read_item(item_id: int, q: Union[str, None] = None):
    return {"item_id": item_id, "q": q}
```

æˆ–è€…ä½¿ç”¨`async def`

```python
from typing import Union

from fastapi import FastAPI

app = FastAPI()


@app.get("/")
async def read_root():
    return {"Hello": "World"}


@app.get("/items/{item_id}")
async def read_item(item_id: int, q: Union[str, None] = None):
    return {"item_id": item_id, "q": q}
```

é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿è¡ŒæœåŠ¡å™¨ï¼š

```bash
uvicorn main:app --reload
```

```bash
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [28720]
INFO:     Started server process [28722]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

> `uvicorn main: app`å‘½ä»¤å«ä¹‰å¦‚ä¸‹ï¼š
>
> - `main`: `main.py`æ–‡ä»¶ï¼›
> - `app`: åœ¨`main.py`æ–‡ä»¶ä¸­é€šè¿‡`app = FastAPI()`åˆ›å»ºçš„å¯¹è±¡ï¼›
> - `--rolad`: è®©æœåŠ¡å™¨åœ¨æ›´æ–°ä»£ç åé‡æ–°å¯åŠ¨ï¼Œä»…åœ¨å¼€å‘æ—¶ä½¿ç”¨è¯¥é€‰é¡¹ã€‚

ä½¿ç”¨æµè§ˆå™¨è®¿é—®http://127.0.0.1:8000/items/5?q=somequeryï¼Œä½ å¯ä»¥çœ‹åˆ°å¦‚ä¸‹JSONå“åº”ï¼š

```json
{"item_id": 5, "q": "somequery"}
```

ä½ å·²ç»åˆ›å»ºäº†ä¸€ä¸ªå…·æœ‰ä»¥ä¸‹åŠŸèƒ½çš„APIï¼š

- é€šè¿‡`è·¯å¾„/`å’Œ`/items/{item_id}`æ¥å—HTTPè¯·æ±‚ï¼›
- ä»¥ä¸Šè·¯å¾„éƒ½æ¥å—`GET`æ“ä½œï¼ˆä¹Ÿè¢«ç§°ä¸ºHTTPæ–¹æ³•ï¼‰ï¼›
- `/items/{item_id}è·¯å¾„`æœ‰ä¸€ä¸ªè·¯å¾„å‚æ•°`item_id`å¹¶ä¸”åº”è¯¥ä¸º`int`ç±»å‹
- `/items/{item_id}`è·¯å¾„æœ‰ä¸€ä¸ªå¯é€‰çš„`str`ç±»å‹çš„æŸ¥è¯¢å‚æ•°`q`ã€‚

è®¿é—®http://127.0.0.1:8000/docsï¼Œä½ ä¼šçœ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„äº¤äº’å¼APIæ–‡æ¡£ï¼ˆç”±[Swagger UI](https://github.com/swagger-api/swagger-ui)ç”Ÿæˆï¼‰ã€‚

è®¿é—®http://127.0.0.1:8000/redocï¼Œä½ ä¼šçœ‹åˆ°å¦ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£ï¼ˆç”±[ReDoc](https://github.com/Rebilly/ReDoc)ç”Ÿæˆï¼‰ã€‚

ä½ å¯èƒ½ç–‘æƒ‘pythonä»£ç å¦‚ä½•èƒ½è½¬æ¢æˆäº¤äº’å¼APIæ–‡æ¡£ï¼Œè¿™å…¶å®æ˜¯OpenAPIä¸ºAPIå®šä¹‰äº†APIæ¨¡å¼ã€‚

- â€œæ¨¡å¼â€æ˜¯å¯¹äº‹ç‰©çš„ä¸€ç§å®šä¹‰æˆ–æè¿°ï¼Œå…¶å¹¶éå…·ä½“çš„å®ç°ä»£ç ï¼Œè€Œåªæ˜¯æŠ½è±¡çš„æè¿°ã€‚

- OpenAPIæ¨¡å¼ä¸­åŒ…å«äº†APIå‘é€å’Œæ¥æ”¶çš„æ•°æ®çš„å®šä¹‰ï¼ˆæ¨¡å¼ï¼‰ï¼Œè¿™äº›å®šä¹‰é€šè¿‡JSONæ•°æ®æ¨¡å¼æ ‡å‡†JSON Schemaç”Ÿæˆã€‚

- æŸ¥çœ‹openapi.jsonï¼Œä½ å¯ä»¥åœ¨http://127.0.0.1:8000/openapi.jsonçœ‹åˆ°ï¼š

  - > {
    >     "openapi": "3.0.2",
    >     "info": {
    >         "title": "FastAPI",
    >         "version": "0.1.0"
    >     },
    >     "paths": {
    >         "/items/": {
    >             "get": {
    >                 "responses": {
    >                     "200": {
    >                         "description": "Successful Response",
    >                         "content": {
    >                             "application/json": {
    >
    > 
    >
    > ...

ä¿®æ”¹main.pyæ–‡ä»¶ä»PUTè¯·æ±‚ä¸­æ¥æ”¶è¯·æ±‚ä½“ã€‚

å€ŸåŠ©Pydanticæ¥ä½¿ç”¨æ ‡å‡†çš„Pythonç±»å‹å£°æ˜è¯·æ±‚ä½“ã€‚

```python
from typing import Union

from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()


class Item(BaseModel):
    name: str
    price: float
    is_offer: Union[bool, None] = None


@app.get("/")
def read_root():
    return {"Hello": "World"}


@app.get("/items/{item_id}")
def read_item(item_id: int, q: Union[str, None] = None):
    return {"item_id": item_id, "q": q}


@app.put("/items/{item_id}")
def update_item(item_id: int, item: Item):
    return {"item_name": item.name, "item_id": item_id}
```

æœåŠ¡å™¨å°†ä¼šé‡è½½ï¼ˆå› ä¸º`uvicorn`å‘½ä»¤ä¸­æ·»åŠ äº†`--reload`é€‰é¡¹ï¼‰ã€‚

å¼€å‘APIæ—¶ï¼Œé€šå¸¸ä½¿ç”¨ç‰¹å®šHTTPæ–¹æ³•æ‰§è¡Œç‰¹å®šçš„è¡Œä¸ºï¼Œé€šå¸¸ä½¿ç”¨ï¼š

- `POST`: åˆ›å»ºæ•°æ®
- `GET`: è¯»å–æ•°æ®
- `PUT`: æ›´æ–°æ•°æ®
- `DELETE`: åˆ é™¤æ•°æ®

åœ¨OpenAPIä¸­ï¼Œæ¯ä¸€ä¸ªHTTPæ–¹æ³•éƒ½è¢«ç§°ä¸ºâ€œæ“ä½œâ€ï¼Œæ¯ä¸€ä¸ªæ“ä½œéƒ½æœ‰è·¯å¾„æ“ä½œè£…é¥°å™¨å’Œå‡½æ•°ç»„æˆã€‚

> `@something`è¯­æ³•åœ¨Pythonä¸­è¢«ç§°ä¸ºâ€œè£…é¥°å™¨â€ã€‚
>
> åƒä¸€é¡¶æ¼‚äº®çš„è£…é¥°å¸½ä¸€æ ·ï¼Œå°†å®ƒæ”¾åœ¨ä¸€ä¸ªå‡½æ•°çš„ä¸Šæ–¹ã€‚
>
> è£…é¥°å™¨æ¥æ”¶ä½äºå…¶ä¸‹æ–¹çš„å‡½æ•°å¹¶ä¸”ç”¨å®ƒå®Œæˆä¸€äº›å·¥ä½œã€‚

å¯¹åº”çš„æ“ä½œæœ‰ï¼š

- `@app.post()`
- `@app.get()`
- `@app.put()`
- `@app.delete()`

ä»¥åŠæ›´å°‘è§çš„ï¼š

- `@app.options()`
- `@app.head()`
- `@app.patch()`
- `@app.trace()`

æ€»çš„æ¥è¯´ï¼Œå°±åƒå£°æ˜å‡½æ•°çš„å‚æ•°ç±»å‹ä¸€æ ·åªå£°æ˜äº†ä¸€æ¬¡è¯·æ±‚å‚æ•°ã€è¯·æ±‚ä½“ç­‰çš„ç±»å‹ã€‚åªéœ€è¦ä½¿ç”¨æ ‡å‡†çš„Pythonè¾ƒé«˜ç‰ˆæœ¬ï¼Œä¸éœ€è¦å­¦ä¹ æ–°çš„è¯­æ³•ã€äº†è§£ç‰¹å®šåº“çš„æ–¹æ³•æˆ–ç±»ã€‚

æ¯”å¦‚å£°æ˜ `int` ç±»å‹ï¼š

```
item_id: int
```

æˆ–è€…ä¸€ä¸ªæ›´å¤æ‚çš„ `Item` æ¨¡å‹ï¼š

```
item: Item
```

......åœ¨è¿›è¡Œä¸€æ¬¡å£°æ˜ä¹‹åï¼Œä½ å°†è·å¾—ï¼š

- ç¼–è¾‘å™¨æ”¯æŒï¼ŒåŒ…æ‹¬ï¼š
  - è‡ªåŠ¨è¡¥å…¨
  - ç±»å‹æ£€æŸ¥
- æ•°æ®æ ¡éªŒï¼š
  - åœ¨æ ¡éªŒå¤±è´¥æ—¶è‡ªåŠ¨ç”Ÿæˆæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
  - å¯¹å¤šå±‚åµŒå¥—çš„ JSON å¯¹è±¡ä¾ç„¶æ‰§è¡Œæ ¡éªŒ
- è½¬æ¢æ¥è‡ªç½‘ç»œè¯·æ±‚çš„è¾“å…¥æ•°æ®ä¸º Python æ•°æ®ç±»å‹ã€‚åŒ…æ‹¬ä»¥ä¸‹æ•°æ®ï¼š
  - JSON
  - è·¯å¾„å‚æ•°
  - æŸ¥è¯¢å‚æ•°
  - Cookies
  - è¯·æ±‚å¤´
  - è¡¨å•
  - æ–‡ä»¶
- è½¬æ¢è¾“å‡ºçš„æ•°æ®ï¼šè½¬æ¢ Python æ•°æ®ç±»å‹ä¸ºä¾›ç½‘ç»œä¼ è¾“çš„ JSON æ•°æ®ï¼š
  - è½¬æ¢ Python åŸºç¡€ç±»å‹ ï¼ˆ`str`ã€ `int`ã€ `float`ã€ `bool`ã€ `list` ç­‰ï¼‰
  - `datetime` å¯¹è±¡
  - `UUID` å¯¹è±¡
  - æ•°æ®åº“æ¨¡å‹
  - ......ä»¥åŠæ›´å¤šå…¶ä»–ç±»å‹
- è‡ªåŠ¨ç”Ÿæˆçš„äº¤äº’å¼ API æ–‡æ¡£ï¼ŒåŒ…æ‹¬ä¸¤ç§å¯é€‰çš„ç”¨æˆ·ç•Œé¢ï¼š
  - Swagger UI
  - ReDoc

# è¿æ¥SQLï¼ˆå…³ç³»å‹ï¼‰æ•°æ®åº“

`SQLModel`æ˜¯åŸºäº`SQLAlchemy`å’Œ`Pydantic`æ„å»ºçš„ï¼Œå®Œç¾åŒ¹é…éœ€è¦ä½¿ç”¨SQLæ•°æ®åº“çš„FastAPIåº”ç”¨ç¨‹åºã€‚

ç”±äº `SQLModel` åŸºäº `SQLAlchemy`ï¼Œå› æ­¤æ‚¨å¯ä»¥è½»æ¾ä½¿ç”¨ä»»ä½•ç”± `SQLAlchemy `æ”¯æŒçš„æ•°æ®åº“ï¼ˆè¿™ä¹Ÿè®©å®ƒä»¬è¢« `SQLModel` æ”¯æŒï¼‰ï¼Œä¾‹å¦‚ï¼š

- PostgreSQL
- MySQL
- SQLite
- Oracle
- Microsoft SQL Server ç­‰.

å®‰è£…`SQLModel`

```bash
pip install sqlmodel
```

å¯¼å…¥`SQLModel`å¹¶åˆ›å»ºä¸€ä¸ªæ•°æ®åº“æ¨¡å‹

```python
from typing import Annotated

from fastapi import Depends, FastAPI, HTTPException, Query
from sqlmodel import Field, Session, SQLModel, create_engine, select


class Hero(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str = Field(index=True)
    age: int | None = Field(default=None, index=True)
    secret_name: str


sqlite_file_name = "database.db"
sqlite_url = f"sqlite:///{sqlite_file_name}"

connect_args = {"check_same_thread": False}
engine = create_engine(sqlite_url, connect_args=connect_args)


def create_db_and_tables():
    SQLModel.metadata.create_all(engine)


def get_session():
    with Session(engine) as session:
        yield session


SessionDep = Annotated[Session, Depends(get_session)]

app = FastAPI()


@app.on_event("startup")
def on_startup():
    create_db_and_tables()


@app.post("/heroes/")
def create_hero(hero: Hero, session: SessionDep) -> Hero:
    session.add(hero)
    session.commit()
    session.refresh(hero)
    return hero


@app.get("/heroes/")
def read_heroes(
    session: SessionDep,
    offset: int = 0,
    limit: Annotated[int, Query(le=100)] = 100,
) -> list[Hero]:
    heroes = session.exec(select(Hero).offset(offset).limit(limit)).all()
    return heroes


@app.get("/heroes/{hero_id}")
def read_hero(hero_id: int, session: SessionDep) -> Hero:
    hero = session.get(Hero, hero_id)
    if not hero:
        raise HTTPException(status_code=404, detail="Hero not found")
    return hero


@app.delete("/heroes/{hero_id}")
def delete_hero(hero_id: int, session: SessionDep):
    hero = session.get(Hero, hero_id)
    if not hero:
        raise HTTPException(status_code=404, detail="Hero not found")
    session.delete(hero)
    session.commit()
    return {"ok": True}
```

`Hero` ç±»ä¸ Pydantic æ¨¡å‹éå¸¸ç›¸ä¼¼ï¼ˆå®é™…ä¸Šï¼Œä»åº•å±‚æ¥çœ‹ï¼Œå®ƒç¡®å®*å°±æ˜¯ä¸€ä¸ª Pydantic æ¨¡å‹*ï¼‰ã€‚

æœ‰ä¸€äº›åŒºåˆ«ï¼š

- `table=True` ä¼šå‘Šè¯‰ SQLModel è¿™æ˜¯ä¸€ä¸ª*è¡¨æ¨¡å‹*ï¼Œå®ƒåº”è¯¥è¡¨ç¤º SQL æ•°æ®åº“ä¸­çš„ä¸€ä¸ª*è¡¨*ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€ä¸ª*æ•°æ®æ¨¡å‹*ï¼ˆå°±åƒå…¶ä»–å¸¸è§„çš„ Pydantic ç±»ä¸€æ ·ï¼‰ã€‚

- `Field(primary_key=True)` ä¼šå‘Šè¯‰ SQLModel `id` æ˜¯ SQL æ•°æ®åº“ä¸­çš„**ä¸»é”®**ï¼ˆæ‚¨å¯ä»¥åœ¨ SQLModel æ–‡æ¡£ä¸­äº†è§£æ›´å¤šå…³äº SQL ä¸»é”®çš„ä¿¡æ¯ï¼‰ã€‚

  æŠŠç±»å‹è®¾ç½®ä¸º `int | None` ï¼ŒSQLModel å°±èƒ½çŸ¥é“è¯¥åˆ—åœ¨ SQL æ•°æ®åº“ä¸­åº”è¯¥æ˜¯ `INTEGER` ç±»å‹ï¼Œå¹¶ä¸”åº”è¯¥æ˜¯ `NULLABLE` ã€‚

- `Field(index=True)` ä¼šå‘Šè¯‰ SQLModel åº”è¯¥ä¸ºæ­¤åˆ—åˆ›å»ºä¸€ä¸ª **SQL ç´¢å¼•**ï¼Œè¿™æ ·åœ¨è¯»å–æŒ‰æ­¤åˆ—è¿‡æ»¤çš„æ•°æ®æ—¶ï¼Œç¨‹åºèƒ½åœ¨æ•°æ®åº“ä¸­è¿›è¡Œæ›´å¿«çš„æŸ¥æ‰¾ã€‚

  SQLModel ä¼šçŸ¥é“å£°æ˜ä¸º `str` çš„å†…å®¹å°†æ˜¯ç±»å‹ä¸º `TEXT` ï¼ˆæˆ– `VARCHAR` ï¼Œå…·ä½“å–å†³äºæ•°æ®åº“ï¼‰çš„ SQL åˆ—ã€‚

SQLModel çš„å¼•æ“ `engine`ï¼ˆå®é™…ä¸Šå®ƒæ˜¯ä¸€ä¸ª SQLAlchemy `engine` ï¼‰æ˜¯ç”¨æ¥ä¸æ•°æ®åº“**ä¿æŒè¿æ¥**çš„ã€‚

æ‚¨åªéœ€æ„å»º**ä¸€ä¸ª `engine`**ï¼Œæ¥è®©æ‚¨çš„æ‰€æœ‰ä»£ç è¿æ¥åˆ°åŒä¸€ä¸ªæ•°æ®åº“ã€‚

ä½¿ç”¨ `check_same_thread=False` å¯ä»¥è®© FastAPI åœ¨ä¸åŒçº¿ç¨‹ä¸­ä½¿ç”¨åŒä¸€ä¸ª SQLite æ•°æ®åº“ã€‚è¿™å¾ˆæœ‰å¿…è¦ï¼Œå› ä¸º**å•ä¸ªè¯·æ±‚**å¯èƒ½ä¼šä½¿ç”¨**å¤šä¸ªçº¿ç¨‹**ï¼ˆä¾‹å¦‚åœ¨ä¾èµ–é¡¹ä¸­ï¼‰ã€‚

ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬ä¼šæŒ‰ç…§ä»£ç ç»“æ„ç¡®ä¿**æ¯ä¸ªè¯·æ±‚ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ SQLModel \*ä¼šè¯\***ï¼Œè¿™å®é™…ä¸Šå°±æ˜¯ `check_same_thread` æƒ³è¦å®ç°çš„ã€‚

**`Session`** ä¼šå­˜å‚¨**å†…å­˜ä¸­çš„å¯¹è±¡**å¹¶è·Ÿè¸ªæ•°æ®ä¸­æ‰€éœ€æ›´æ”¹çš„å†…å®¹ï¼Œç„¶åå®ƒ**ä½¿ç”¨ `engine`** ä¸æ•°æ®åº“è¿›è¡Œé€šä¿¡ã€‚

æˆ‘ä»¬ä¼šä½¿ç”¨ `yield` åˆ›å»ºä¸€ä¸ª FastAPI **ä¾èµ–é¡¹**ï¼Œä¸ºæ¯ä¸ªè¯·æ±‚æä¾›ä¸€ä¸ªæ–°çš„ `Session` ã€‚è¿™ç¡®ä¿æˆ‘ä»¬æ¯ä¸ªè¯·æ±‚ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ä¼šè¯ã€‚ğŸ¤“

ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `Annotated` çš„ä¾èµ–é¡¹ `SessionDep` æ¥ç®€åŒ–å…¶ä»–ä¹Ÿä¼šç”¨åˆ°æ­¤ä¾èµ–çš„ä»£ç ã€‚

è¿è¡Œåº”ç”¨ç¨‹åº

```bash
fastapi dev main.py
```

åœ¨ **SQLModel** ä¸­ï¼Œä»»ä½•å«æœ‰ `table=True` å±æ€§çš„æ¨¡å‹ç±»éƒ½æ˜¯ä¸€ä¸ª**è¡¨æ¨¡å‹**ã€‚

ä»»ä½•ä¸å«æœ‰ `table=True` å±æ€§çš„æ¨¡å‹ç±»éƒ½æ˜¯**æ•°æ®æ¨¡å‹**ï¼Œè¿™äº›å®é™…ä¸Šåªæ˜¯ Pydantic æ¨¡å‹ï¼ˆé™„å¸¦ä¸€äº›å°çš„é¢å¤–åŠŸèƒ½ï¼‰ã€‚ğŸ¤“

æœ‰äº† SQLModelï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨**ç»§æ‰¿**æ¥åœ¨æ‰€æœ‰æƒ…å†µä¸‹**é¿å…é‡å¤**æ‰€æœ‰å­—æ®µã€‚

æˆ‘ä»¬ä»ä¸€ä¸ª `HeroBase` æ¨¡å‹å¼€å§‹ï¼Œè¯¥æ¨¡å‹å…·æœ‰æ‰€æœ‰æ¨¡å‹**å…±äº«çš„å­—æ®µ**ï¼š

- `name`
- `age`

```python
class HeroBase(SQLModel):
    name: str = Field(index=True)
    age: int | None = Field(default=None, index=True)
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»º `Hero` ï¼Œå®é™…çš„*è¡¨æ¨¡å‹*ï¼Œå¹¶æ·»åŠ é‚£äº›ä¸æ€»æ˜¯åœ¨å…¶ä»–æ¨¡å‹ä¸­çš„**é¢å¤–å­—æ®µ**ï¼š

- `id`
- `secret_name`

å› ä¸º `Hero` ç»§æ‰¿è‡ª HeroBase ï¼Œæ‰€ä»¥å®ƒ**ä¹Ÿ**åŒ…å«äº†åœ¨ `HeroBase` ä¸­å£°æ˜è¿‡çš„**å­—æ®µ**ã€‚å› æ­¤ `Hero` çš„æ‰€æœ‰å­—æ®µä¸ºï¼š

- `id`
- `name`
- `age`
- `secret_name`

```python
class HeroBase(SQLModel):
    name: str = Field(index=True)
    age: int | None = Field(default=None, index=True)


class Hero(HeroBase, table=True):
    id: int | None = Field(default=None, primary_key=True)
    secret_name: str
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `HeroPublic` æ¨¡å‹ï¼Œè¿™æ˜¯å°†**è¿”å›**ç»™ API å®¢æˆ·ç«¯çš„æ¨¡å‹ã€‚

å®ƒåŒ…å«ä¸ `HeroBase` ç›¸åŒçš„å­—æ®µï¼Œå› æ­¤ä¸ä¼šåŒ…æ‹¬ `secret_name` ã€‚

ç»ˆäºï¼Œæˆ‘ä»¬è‹±é›„ï¼ˆheroï¼‰çš„èº«ä»½å¾—åˆ°äº†ä¿æŠ¤ï¼ ğŸ¥·

å®ƒè¿˜é‡æ–°å£°æ˜äº† `id: int` ã€‚è¿™æ ·æˆ‘ä»¬ä¾¿ä¸ API å®¢æˆ·ç«¯å»ºç«‹äº†ä¸€ç§**çº¦å®š**ï¼Œä½¿ä»–ä»¬å§‹ç»ˆå¯ä»¥æœŸå¾… `id` å­˜åœ¨å¹¶ä¸”æ˜¯ä¸€ä¸ªæ•´æ•° `int`ï¼ˆæ°¸è¿œä¸ä¼šæ˜¯ `None` ï¼‰ã€‚

`HeroPublic` ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½ä¸ `HeroBase` ä¸­çš„ç›¸åŒï¼Œå…¶ä¸­ `id` å£°æ˜ä¸º `int` ï¼ˆä¸æ˜¯ `None` ï¼‰ï¼š

- `id`
- `name`
- `age`
- `secret_name`

```python
class HeroBase(SQLModel):
    name: str = Field(index=True)
    age: int | None = Field(default=None, index=True)


class Hero(HeroBase, table=True):
    id: int | None = Field(default=None, primary_key=True)
    secret_name: str


class HeroPublic(HeroBase):
    id: int
```

ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `HeroCreate` æ¨¡å‹ï¼Œè¿™æ˜¯ç”¨äº**éªŒè¯**å®¢æˆ·æ•°æ®çš„æ¨¡å‹ã€‚

å®ƒä¸ä»…æ‹¥æœ‰ä¸ `HeroBase` ç›¸åŒçš„å­—æ®µï¼Œè¿˜æœ‰ `secret_name` ã€‚

ç°åœ¨ï¼Œå½“å®¢æˆ·ç«¯**åˆ›å»ºä¸€ä¸ªæ–°çš„ hero** æ—¶ï¼Œä»–ä»¬ä¼šå‘é€ `secret_name` ï¼Œå®ƒä¼šè¢«å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œä½†è¿™äº› `secret_name` ä¸ä¼šé€šè¿‡ API è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

`HeroCreate` çš„å­—æ®µåŒ…æ‹¬ï¼š

- `name`
- `age`
- `secret_name`

```python
class HeroBase(SQLModel):
    name: str = Field(index=True)
    age: int | None = Field(default=None, index=True)


class Hero(HeroBase, table=True):
    id: int | None = Field(default=None, primary_key=True)
    secret_name: str


class HeroPublic(HeroBase):
    id: int


class HeroCreate(HeroBase):
    secret_name: str
```

åœ¨ä¹‹å‰çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•**æ›´æ–° hero**ï¼Œä½†ç°åœ¨æœ‰äº†**å¤šä¸ªæ¨¡å‹**ï¼Œæˆ‘ä»¬ä¾¿èƒ½åšåˆ°è¿™ä¸€ç‚¹äº†ã€‚ğŸ‰

`HeroUpdate` *æ•°æ®æ¨¡å‹*æœ‰äº›ç‰¹æ®Šï¼Œå®ƒåŒ…å«åˆ›å»ºæ–° hero æ‰€éœ€çš„**æ‰€æœ‰ç›¸åŒå­—æ®µ**ï¼Œä½†æ‰€æœ‰å­—æ®µéƒ½æ˜¯**å¯é€‰çš„**ï¼ˆå®ƒä»¬éƒ½æœ‰é»˜è®¤å€¼ï¼‰ã€‚è¿™æ ·ï¼Œå½“æ‚¨æ›´æ–°ä¸€ä¸ª hero æ—¶ï¼Œæ‚¨å¯ä»¥åªå‘é€æ‚¨æƒ³è¦æ›´æ–°çš„å­—æ®µã€‚

å› ä¸ºæ‰€æœ‰**å­—æ®µå®é™…ä¸Š**éƒ½å‘ç”Ÿäº†**å˜åŒ–**ï¼ˆç±»å‹ç°åœ¨åŒ…æ‹¬ `None` ï¼Œå¹¶ä¸”å®ƒä»¬ç°åœ¨æœ‰ä¸€ä¸ªé»˜è®¤å€¼ `None` ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦**é‡æ–°å£°æ˜**å®ƒä»¬ã€‚

æˆ‘ä»¬ä¼šé‡æ–°å£°æ˜æ‰€æœ‰å­—æ®µï¼Œå› æ­¤æˆ‘ä»¬å¹¶ä¸æ˜¯çœŸçš„éœ€è¦ä» `HeroBase` ç»§æ‰¿ã€‚æˆ‘ä¼šè®©å®ƒç»§æ‰¿åªæ˜¯ä¸ºäº†ä¿æŒä¸€è‡´ï¼Œä½†è¿™å¹¶ä¸å¿…è¦ã€‚è¿™æ›´å¤šæ˜¯ä¸ªäººå–œå¥½çš„é—®é¢˜ã€‚ğŸ¤·

`HeroUpdate` çš„å­—æ®µåŒ…æ‹¬:

- `name`
- `age`
- `secret_name`

```python
class HeroBase(SQLModel):
    name: str = Field(index=True)
    age: int | None = Field(default=None, index=True)


class Hero(HeroBase, table=True):
    id: int | None = Field(default=None, primary_key=True)
    secret_name: str


class HeroPublic(HeroBase):
    id: int


class HeroCreate(HeroBase):
    secret_name: str


class HeroUpdate(HeroBase):
    name: str | None = None
    age: int | None = None
    secret_name: str | None = None
```

æ—¢ç„¶æˆ‘ä»¬æœ‰äº†**å¤šä¸ªæ¨¡å‹**ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ä½¿ç”¨å®ƒä»¬çš„åº”ç”¨ç¨‹åºéƒ¨åˆ†è¿›è¡Œæ›´æ–°ã€‚

æˆ‘ä»¬åœ¨è¯·æ±‚ä¸­æ¥æ”¶åˆ°ä¸€ä¸ª `HeroCreate` *æ•°æ®æ¨¡å‹*ï¼Œç„¶åä»ä¸­åˆ›å»ºä¸€ä¸ª `Hero` *è¡¨æ¨¡å‹*ã€‚

è¿™ä¸ªæ–°çš„*è¡¨æ¨¡å‹* `Hero` ä¼šåŒ…å«å®¢æˆ·ç«¯å‘é€çš„å­—æ®µï¼Œä»¥åŠä¸€ä¸ªç”±æ•°æ®åº“ç”Ÿæˆçš„ `id` ã€‚

ç„¶åæˆ‘ä»¬å°†ä¸å‡½æ•°ä¸­ç›¸åŒçš„*è¡¨æ¨¡å‹* `Hero` åŸæ ·è¿”å›ã€‚ä½†æ˜¯ç”±äºæˆ‘ä»¬ä½¿ç”¨ `HeroPublic` *æ•°æ®æ¨¡å‹*å£°æ˜äº† `response_model` ï¼Œ**FastAPI** ä¼šä½¿ç”¨ `HeroPublic` æ¥éªŒè¯å’Œåºåˆ—åŒ–æ•°æ®ã€‚

```python
@app.post("/heroes/", response_model=HeroPublic)
def create_hero(hero: HeroCreate, session: SessionDep):
    db_hero = Hero.model_validate(hero)
    session.add(db_hero)
    session.commit()
    session.refresh(db_hero)
    return db_hero
```

æˆ‘ä»¬å¯ä»¥åƒä¹‹å‰ä¸€æ ·**è¯»å–** `Hero` ã€‚åŒæ ·ï¼Œä½¿ç”¨ `response_model=list[HeroPublic]` ç¡®ä¿æ­£ç¡®åœ°éªŒè¯å’Œåºåˆ—åŒ–æ•°æ®ã€‚

```python
@app.get("/heroes/", response_model=list[HeroPublic])
def read_heroes(
    session: SessionDep,
    offset: int = 0,
    limit: Annotated[int, Query(le=100)] = 100,
):
    heroes = session.exec(select(Hero).offset(offset).limit(limit)).all()
    return heroes
```

æˆ‘ä»¬å¯ä»¥**è¯»å–**å•ä¸ª `hero` ã€‚

```python
@app.get("/heroes/{hero_id}", response_model=HeroPublic)
def read_hero(hero_id: int, session: SessionDep):
    hero = session.get(Hero, hero_id)
    if not hero:
        raise HTTPException(status_code=404, detail="Hero not found")
    return hero
```

æˆ‘ä»¬å¯ä»¥æ›´æ–°å•ä¸ª hero ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ HTTP çš„ PATCH æ“ä½œã€‚
åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ª dict ï¼Œå…¶ä¸­åŒ…å«å®¢æˆ·ç«¯å‘é€çš„æ‰€æœ‰æ•°æ®ï¼Œåªæœ‰å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼Œå¹¶æ’é™¤äº†ä»»ä½•ä¸€ä¸ªä»…ä»…ä½œä¸ºé»˜è®¤å€¼å­˜åœ¨çš„å€¼ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ exclude_unset=True ã€‚è¿™æ˜¯æœ€ä¸»è¦çš„æŠ€å·§ã€‚ğŸª„
ç„¶åæˆ‘ä»¬ä¼šä½¿ç”¨ hero_db.sqlmodel_update(hero_data) ï¼Œæ¥åˆ©ç”¨ hero_data çš„æ•°æ®æ›´æ–° hero_dbã€‚

```python
@app.patch("/heroes/{hero_id}", response_model=HeroPublic)
def update_hero(hero_id: int, hero: HeroUpdate, session: SessionDep):
    hero_db = session.get(Hero, hero_id)
    if not hero_db:
        raise HTTPException(status_code=404, detail="Hero not found")
    hero_data = hero.model_dump(exclude_unset=True)
    hero_db.sqlmodel_update(hero_data)
    session.add(hero_db)
    session.commit()
    session.refresh(hero_db)
    return hero_db
```

**åˆ é™¤**ä¸€ä¸ª hero åŸºæœ¬ä¿æŒä¸å˜ã€‚

æˆ‘ä»¬ä¸ä¼šæ»¡è¶³åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­é‡æ„ä¸€åˆ‡çš„æ„¿æœ›ã€‚ğŸ˜…

```python
@app.delete("/heroes/{hero_id}")
def delete_hero(hero_id: int, session: SessionDep):
    hero = session.get(Hero, hero_id)
    if not hero:
        raise HTTPException(status_code=404, detail="Hero not found")
    session.delete(hero)
    session.commit()
    return {"ok": True}
```



# å‚è€ƒèµ„æ–™

1. [FastAPIå®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
2. [æºç ](https://github.com/fastapi/fastapi)